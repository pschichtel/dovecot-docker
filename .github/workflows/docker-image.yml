name: Docker Image CI

on: [ push, workflow_dispatch ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build the Docker image
      run: |
        codename="bookworm"
        repo_name="ghcr.io/pschichtel/dovecot"
        tmp_image_name="$repo_name:latest"
        podman build -t "$tmp_image_name" .
        version="$(podman run --rm --entrypoint sh "$tmp_image_name" -c 'dovecot --version | grep -Po "^\S+"')"
        major_version="$(echo "$version" | cut -d'.' -f1)"
        podman tag "$tmp_image_name" "$repo_name:$codename" "$repo_name:$version-$codename" "$repo_name:$major_version-$codename"
        podman push "$repo_name:$codename"
        podman push "$repo_name:$version-$codename"
        podman push "$repo_name:$major_version-$codename"

